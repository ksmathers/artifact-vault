#!/usr/bin/env python3
"""
Direct download from HuggingFace through Artifact Vault.

This bypasses huggingface_hub library issues by directly constructing URLs.
"""

import sys
import os
import requests
from pathlib import Path

def download_hf_file(repo_id, filename, vault_url="http://localhost:8080", revision="main"):
    """Download a HuggingFace file through Artifact Vault."""
    
    # Construct the URL
    url = f"{vault_url}/huggingface/{repo_id}/resolve/{revision}/{filename}"
    
    print(f"Downloading: {repo_id}/{filename}")
    print(f"URL: {url}")
    
    # Create cache directory similar to HF
    cache_dir = Path.home() / ".cache" / "artifact-vault" / "huggingface"
    file_path = cache_dir / repo_id / revision / filename
    file_path.parent.mkdir(parents=True, exist_ok=True)
    
    # Download with progress
    response = requests.get(url, stream=True)
    response.raise_for_status()
    
    total_size = int(response.headers.get('content-length', 0))
    downloaded = 0
    
    with open(file_path, 'wb') as f:
        for chunk in response.iter_content(chunk_size=32768):
            if chunk:
                f.write(chunk)
                downloaded += len(chunk)
                if total_size:
                    percent = (downloaded / total_size) * 100
                    print(f"\rProgress: {downloaded}/{total_size} bytes ({percent:.1f}%)", end='')
    
    print(f"\n✓ Downloaded to: {file_path}")
    return file_path

if __name__ == '__main__':
    if len(sys.argv) < 3:
        print("Usage: hfd REPO_ID FILENAME [REVISION]")
        print("Example: hfd bartowski/Llama-3.2-3B-Instruct-GGUF Llama-3.2-3B-Instruct-Q5_K_M.gguf")
        sys.exit(1)
    
    repo_id = sys.argv[1]
    filename = sys.argv[2]
    revision = sys.argv[3] if len(sys.argv) > 3 else "main"
    
    try:
        path = download_hf_file(repo_id, filename, revision=revision)
        print(f"\nFile ready at: {path}")
    except Exception as e:
        print(f"\n✗ Error: {e}")
        sys.exit(1)
